# Pettie TFT

## 프로젝트 소개

### 계정관련 API
- 계정 생성(회원가입)
- 로그인
- 재화 충전
- 재화 조회

### 전투관련 API
- 팀 편성
- 대표 챔피언 지정
- 전투(정규, 친선)
- 랭킹 조회

### 챔피언관련 API
- 챔피언 도감 조회
- 보유 챔피언 조회
- 챔피언 뽑기(+ 픽업 선택 기능)
- 챔피언 판매
- 챔피언 강화

### 챔피언 모델링

- **포지션은 셋 (탱커 / 전사 / 마법사)**

- **목표 챔피언 수는 48명**
	- `S급` : 16명 *(포지션 적절히 분배)*
	- `A급` : 36명 *(포지션 적절히 분배)*
   
- **목표 팀 수는 8팀 (팀 당 인원 6명)**
	- 팀 당 탱커 2명, 전사 2명, 마법사 2명
	- 팀 당 S급 2명, A급 4명
  
- **포지션 별로 특화 스탯 다름**
	- 전 스탯 기본값 동일하게 100으로 설정
	- 특화 스탯은 기본값보다 50% 높음
	- `탱커 특화` : 체력, 방어력
	- `전사 특화` : 물리공격력, 치명타
	- `마법사 특화` : 마법공격력, 마나
  
- **S급 스탯이 A급 보다 20% 높음**
- 
### 미들웨어

1. **인증 미들웨어** : 헤더에서 `Access Token` 가져와서 토큰 타입과 토큰 검증 후, 인증되면 사용자 정보 `req.user`에 담아 보내준다!
   
2. **챔프 검증 미들웨어** : 다중 입력인지 단일 입력인지 확인하고, 입력된 챔피언의 키가 챔프가 데이터베이스에 존재하는 지 검증 후, 인증되면  `req.agents`에 담아 보내준다!

### 라우터

1. **계정 라우터**
	- `회원가입` : 아이디는 이메일 형식으로, 비밀번호는 영소문자와 숫자, 특수문자로 이루어지도록 하고 최소 6글자 이상으로 제약!
	- `로그인` : 아이디와 비밀번호 입력!
	- `캐시충전` : 원하는 금액 설정해 충전! 충전 금액의 1%만큼 마일리지 쌓임!
	- `재화조회` : 로그인된 계정의 캐쉬, 마일리지, 강화재료 보유량 조회

2. **챔프 라우터**
	- `챔프 뽑기` : 픽업 S급 챔프 설정해 뽑기 가능.
		- 1회 또는 10회 선택 가능.
		- S급은 뽑기 50회마다 픽업 챔프 확정 등장
		- A급은 뽑기 5회마다 랜덤 챔프 확정 등장
		- 기본확률은 강화재료 70%, A급 24%, S급 6%
		  *(픽업 3.3%*1명 + 논픽업 각각 0.18%*15명)*
	- `챔프 매각` : 보유 챔프 판매
		- S급 개당 300,000캐시 반환, A급 개당 100,000캐시 반환
	- `챔프 강화` : 챔프 전 스탯 소폭 성장시키는 시스템
		- 성공, 실패, 하락 존재. 하락은 10강 이상부터 발생.
		- 강화재료가 모자란 경우 1개 당 100 마일리지로 대체해 시도 가능
		- 수치에 따른 확률 및 소모재화 변동
			- `0~3강` : 성공 90% 재료 1개
			- `4~6강` : 성공 70% 재료 3개
			- `7~9강` : 성공 50% 재료 5개
			- `10~12강` : 성공 25% 재료 6개
			- `13강 이상` : 성공 10% 재료 7개
	- `챔프 승급` : 챔프 특화 스탯 대폭 성장시키는 시스템
		- 챔프 중복 보유량 1개씩 소모해 승급 1회 가능
	- `도감 조회` : 원하는 정렬 조건 입력해 게임 내 존재하는 챔프들 조회 가능
		- 예를 들어, 팀별 조회를 선택하고, 팀을 녹서스로 지정, 포지션 기준으로 내림차순 등의 조건으로 조회가 가능
	- `보유 챔프 조회` : 보유한 챔프 전부 조회하는 단순한 기능

3. **매치 라우터**
	- `공격대 편성` : 보유 챔프 중 셋 선정해 편성
		- 제약 조건으로 탱커 최소 한 명 필수 편성을 요구
		- 같은 소속 챔프 둘 이상 편성 시 시너지가 발동돼, 팀 종합 스탯 상승시켜줌.
	- `대표 챔프` : 최애의 챔프를 골라 프로필에 보여지는 기능. 아쉽게도 프로필 조회 기능이 없기 때문에 랭킹 조회 시 대표 챔프 표시 칸이 있음
	- `친선전` : 상대 계정 닉네임 통해 친선 전투 진행하는 기능. 패작 등의 부작용 우려로 인해 보상 없고, 랭킹 변동 없고, 경기 결과 기록 안 됨.
	- `정규전` : 자신의 mmr ±1000점대 유저들 그룹에서 한명을 랜덤 선정에 전투
		- 랭킹 변동 있고, 경기 결과 전적에 기록됨
		- 경기 결과에 따른 차등 보상 획득
			- `승자` : mmr +50, 강화재료 +10, 캐시 +50,000
			- `패자` : mmr -20, 강화재료 +2, 캐시 +10,000
			- `비길 시` : mmr +5, 강화재료 +5, 캐시 +30,000)
	- `랭킹 조회` : mmr 높은 순으로 상위 10명을 조회
		- 만약 동점이 있다면, 패배수가 적은 사람이 상위에 위치함

---

## Data Base 소개 
- 설계한 초기 DB(MySql)

![초기ERD](https://github.com/user-attachments/assets/386d2fdd-aa98-411f-9057-a129cde9df30)

초기 DB 설계에선 뽑기내역 및 충전내역을 확인하기 위해 테이블을 생성해 두었으나, 
관련 기능구현을 배제함에 따라 삭제하게 되었습니다.

- 수정한 프로젝트 DB(MySql)

![마지막ERD](https://github.com/user-attachments/assets/7d33f06c-b31c-4d83-b069-0afe0bfbffed)

### Users 

사용자의 정보를 저장해두기 위한 테이블입니다.

| Column | Description | 
| --- | --- |
| user_key | 유저의 기본 키(PRIMARY KEY)로 유저를 구분하기 위해 존재합니다. |
| id | 유저의 아이디로 이메일형식으로 저장되며, 겹치지 않도록 UNIQUE 특성을 적용하였습니다. |
| pw | 유저의 비밀번호를 bcryp를 이용해 해시화한 값으로 저장되며, 이를 이용해 로그인 성공여부를 확인하게 됩니다. |
| nickname |  유저가 회원가입 시 입력하는 값으로 유저의 이름입니다. |
| squad_mem1~3 | 유저가 전투에서 사용하게될 챔프의 <agentKey>로, 팀 편성 API를 이용해 값을 저장하게 됩니다. |
| favorite_agent | 유저의 대표 챔피언으로 설정할 챔프의 <agentKey>를 저장합니다. |
| created_at | 유저가 생성된(회원가입 성공) 날짜를 기록합니다. |
| synergy | 팀 편성 시, 챔프의 진영이 겹치는 경우 그 진영의 이름을 저장합니다. |

## Agents

챔피언의 기본 정보를 저장해두기 위한 테이블입니다.

| Column | Description | 
| --- | --- |
| agent_key | 챔프의 기본 키(PRIMARY KEY)로 챔피언을 구분하기 위해 존재합니다. |
| name | 챔프의 이름입니다. |
| team | 챔프의 진영입니다. 팀 편성 시 시너지효과에 이용됩니다. |
| url |  챔프의 이미지 url을 저장한 값입니다. 프론트 엔드(html)에서 사용합니다. |
| position | 챔프의 포지션(역할)을 정해줍니다 값은 탱커(tanker)/마법사(wizard)/전사(warrior) 로 되어있습니다. |
| grade | 챔피언의 등급을 정해줍니다 값은 S/A 로 되어있습니다. |

## Assets

사용자를 생성할 때 같이 생성되며, 사용자의 재화를 저장하는 "지갑" 역할을 합니다

| Column | Description | 
| --- | --- |
| asset_key | 지갑의 기본 키(PRIMARY KEY)로 지갑을 구분하기 위해 존재합니다 |
| user_key |  지갑이 생성될 때 지정되며, 지갑을 소유한 사용자의 key 입니다 |
| cash | 유저의 기본 재화로 뽑기를 할 때 사용하게됩니다. |
| mileage | 캐시 충전 시, 충전된 캐쉬의 1%의 값으로 지급됩니다. 강화 재료로 치환하여 사용합니다. |
| enhancer | 강화 재료로 챔피언을 강화 할 때 사용하게 됩니다.|
| count_A | 뽑기 시에 10번 당 A급이 뽑히도록 만드는 로직에 사용되는 값 입니다. |
| count_S | 뽑기 시에 50번 당 픽업으로 선택한 S급이 뽑히도록 만드는 로직에 사용되는 값 입니다. |

## Ranks

사용자의 랭크 정보를 저장하는데 사용되는 테이블 입니다.

| Column | Description | 
| --- | --- |
| rank_key | 랭크의 기본 키(PRIMARY KEY)로 지갑을 구분하기 위해 존재합니다 |
| user_key | 랭크정보가 생성될 때 지정되며, 랭크정보와 연결된 사용자의 key 입니다|
| win_count | 정규전을 통해 승리한 수를 저장합니다. |
| draw_count | 정규전을 통해 비긴 수를 저장합니다. |
| lose_count | 정규전을 통해 패배한 수를 저장합니다. |
| mmr | 정규전을 통해 얻은 점수를 저장합니다. 랭킹 조회에 이용됩니다. |
| updated_at | 마지막으로 랭크전(정규전)을 시행했을 때의 시간을 저장합니다. |

## MyAgents

| Column | Description | 
| --- | --- |
| userkey_agentKey | 복합 기본 키로 MyAgents에서 사용자-챔피언을 구분할 때 사용합니다.
| user_key | 챔피언을 소유한 사용자의 key 입니다.( 복합키에 사용됩니다. )|
| agnet_key | 소유될 챔피언의 key 입니다.( 복합키에 사용됩니다. ) |
| level | 챔피언의 강화 정보입니다. (최대 15) |
| class | 챔피언의 승급 정보입니다. (최대 6) |
| count | 소유한 동일 챔피언의 수입니다. |
| obtained_at | 마지막으로 얻은 시간을 저장합니다. |

## Stats

| Column | Description | 
| --- | --- |
| stat_key | 스탯의 기본 키(PRIMARY KEY)로 스탯을 구분하기 위해 존재합니다 |
| agent_key | 스탯에 연결된 챔피언의 key 입니다. |
| ad | 공격력으로 전사(warrior) 역할군에서 가중치를 받습니다. |
| ap | 주문력으로 마법사(wizard) 역할군에서 가중치를 받습니다. |
| hp | 체력으로 탱커(tanker) 역할군에서 가중치를 받습니다. |
| mp | 마나로 마법사(wizard) 역할군에서 가중치를 받습니다. |
| def | 방어력으로 탱커(tanker) 역할군에서 가중치를 받습니다. |
| crit | 치명타로 전사(warrior) 역할군에서 가중치를 받습니다. |

---

## 프로젝트 컨셉

### 회원가입 

1. 아이디<ID> 는 이메일 형식으로 입력되었는가?

2. 비밀번호<PW> 는 영어 소문자,숫자,특수기호 하나 이상 혼합 하여 6자 이상인가?

3. 비밀번호확인<PWCHECK> 가 입력되었으며, <PW>와 동일한가 ?

4. 위의 조건들을 만족하였을 경우 회원가입에 성공하여 <ID>와 <PW>(bcrypt를 이용해 암호화) 및 <NICKNAME>을 DB에 저장합니다.

5. 회원가입 성공 시, 사용자에게 정보를 전달합니다

![sing-up](https://github.com/user-attachments/assets/68ee0518-4f9e-4d4e-9a66-3484d8f30094)

### 로그인

1. 유저의 존재여부 및 DB에 존재하는 (해시방식으로 암호화된)비밀번호를 비교하여 로그인 성공여부를 결정합니다.

2. 로그인 성공 시, 헤더에 <ID_KEY> 값을 가진 토큰(JWT를 이용해 암호화/만료기간이 설정)을 지급합니다.

3. 추가로 사용자에게 로그인 되었다는 사실을 전달합니다.

![log-in](https://github.com/user-attachments/assets/b3d2868d-5326-45e9-9872-6ae904ad585d)

### 재화(캐시) 충전

1. 로그인 된 상태(헤더에 로그인 시 지급받은 토큰이 유효할 때) 를 확인합니다.

2. <AMOUNT> 를 입력하여 충전할 캐시의 금액을 정해줍니다.

3. 충전된 만큼을 사용자에게 전달합니다.

![캐쉬충전](https://github.com/user-attachments/assets/1ef2c11e-2b7f-4620-aeaa-2281f5272159)

### 재화 조회

1. 로그인 된 상태(헤더에 로그인 시 지급받은 토큰이 유효할 때) 를 확인합니다.

2. 본인이 가지고 있는 재화(강화재료, 마일리지, 캐시)를 전달합니다.

![재화조회](https://github.com/user-attachments/assets/2de41f0b-2f03-40fd-b0dc-f0bc89346ae9)

### 팀 편성

1. 로그인 된 상태(헤더에 로그인 시 지급받은 토큰이 유효할 때) 를 확인합니다.

2. 팀 편성에 필요한 챔피언들의 <ID>(숫자)를 3개 받습니다.

3. 이후 팀 편성에 들어간 챔피언들이 존재하는지, 팀에 최소 탱커 1명이 들어가 있는지 확인 합니다.

4. 위의 조건을 만족하였다면, 챔피언들의 진영 에 따라 2명 이상 같은 진영일 경우 시너지를 활성화 합니다!

5. 편성된 팀과 활성화된 시너지를 사용자에게 전달합니다.

![팀편성](https://github.com/user-attachments/assets/32b0c992-d774-4657-a0c7-65c1b11d5bbf)

### 대표 챔피언 설정

1. 로그인 된 상태(헤더에 로그인 시 지급받은 토큰이 유효할 때) 를 확인합니다.

2. 대표로 선정할 챔피언의 <ID>(숫자)를 받습니다.

3. 챔피언의 존재유무를 확인하여 존재할 시, 대표 챔피언으로 설정하며 이를 사용자에게 전달합니다.

![대표챔프설정](https://github.com/user-attachments/assets/fe711369-da59-4f92-ae14-bcd9a1000b0a)

### 전투 (정규, 친선)

1. 로그인 된 상태(헤더에 로그인 시 지급받은 토큰이 유효할 때) 를 확인합니다.

2. 친선전을 진행할 유저의 닉네임을 받습니다(친선) / 자신과 비슷한 점수(MMR)을 가진 유저를 찾습니다.

3. 사용자와 상대방의 점수를 계산/비교 하여 패배/승리를 정해줍니다.

  1. 점수를 계산할 때 팀의 시너지 가중치, 포지션에 따른 스탯 가중치, 챔프의 강화/승급 레벨에 따른 가중치가 적용됩니다.

4. 결과를 사용자에게 전달합니다.

- 친선전

![친선전](https://github.com/user-attachments/assets/fb578036-8500-44f6-8429-2ffab025825c)

- 정규전

![정규전](https://github.com/user-attachments/assets/dc6a2fdd-c1af-4a23-9c15-03b26d7837d8)

### 랭킹 조회

점수(mmr) 와 승률(패배횟수가 적은 경우)로 정렬하여 TOP10의 결과를 보여줍니다.

![랭킹조회](https://github.com/user-attachments/assets/779131bc-9332-48c1-b8d2-2d2c075d161e)

### 챔피언 도감 조회

DB에 저장된 챔프 도감을 사용자에게 전달합니다.

![챔프도감조회](https://github.com/user-attachments/assets/0109665d-bb6f-41c3-8dde-463f058e9044)

### 보유 챔피언 조회

1. 로그인 된 상태(헤더에 로그인 시 지급받은 토큰이 유효할 때) 를 확인합니다.

2. 보유하고 있는 챔프를 사용자에게 전달합니다.

![보유챔프조회](https://github.com/user-attachments/assets/0edd6389-b793-4a52-90b1-6f84781786fd)

### 챔피언 뽑기(픽업 선택)

1. 로그인 된 상태(헤더에 로그인 시 지급받은 토큰이 유효할 때) 를 확인합니다.

2. 입력받은 횟수만큼의 캐쉬가 충분한지 DB에서 확인을 합니다.

3. 픽업 챔프를 입력으로 받고, S급 챔프인지 확인합니다. (아닐경우 거부)

4. 챔프를 일정 확률(S급 6% / A급 24% / 강화재료 70%)로 획득하며, 50개를 뽑았을 경우 픽업 챔프를 확정으로 획득하게 됩니다  
(50개가 채워지기 전에 S급이 뽑히면 스택이 초기화 됩니다.)

5. 획득된 목록을 사용자에게 전달합니다.

![챔프뽑기](https://github.com/user-attachments/assets/8602b883-b004-46df-9b2c-0a9c89629be9)

### 챔피언 판매

1. 로그인 된 상태(헤더에 로그인 시 지급받은 토큰이 유효할 때) 를 확인합니다.

2. 매각할 챔프가 유저가 충분히 소유하고 있는지 확인합니다.

3. 챔프를 충분히 소지하였을 경우, 이를 판매하여 캐쉬를 지급 받습니다.

![챔프매각](https://github.com/user-attachments/assets/c5f50203-beca-40ac-808c-041abd95d0e7)
   
### 챔피언 강화 / 승급

1. 로그인 된 상태(헤더에 로그인 시 지급받은 토큰이 유효할 때) 를 확인합니다.

2. 강화/승급할 챔피언을 입력으로 받아 소유 여부 및 존재 여부를 확인합니다.

- 챔피언 강화

  1. 챔피언의 강화레벨에 따라 필요한 강화재료를 확인합니다(추가로 부족할 경우 100 마일리지 당 강화재료 1개로 치환합니다)
 
  2. 재료가 충분할 경우, 강화레벨에 따른 가변확률로 강화 성공 여부를 정합니다.(최대 15레벨)
 
  3. 강화 결과를 사용자에게 전달합니다.

![챔프강화](https://github.com/user-attachments/assets/afaa16de-118d-4489-a12a-3f4a816367eb)
 
- 챔피언 승급

  1. 선택한 챔피언이 사용자에게 2개 이상 존재하는지 확인 합니다.
     
  2. 소유한 챔피언을 -1 하며 챔피언의 승급레벨을 +1 올립니다.(최대 6레벨)

![챔프승급](https://github.com/user-attachments/assets/3c9643d8-fb33-4382-9800-91b558e0c7f0)
